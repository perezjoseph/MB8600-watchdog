# Build stage
FROM --platform=linux/amd64 python:3.11-slim AS builder

WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --target=/build -r requirements.txt

# Runtime stage
FROM --platform=linux/amd64 python:3.11-slim

# Set labels for GitHub Container Registry
LABEL org.opencontainers.image.source=https://github.com/perezjoseph/MB8600-watchdog
LABEL org.opencontainers.image.description="Enhanced MB8600-watchdog with TCP/IP diagnostics, outage tracking, and advanced logging"
LABEL org.opencontainers.image.licenses=MIT
LABEL org.opencontainers.image.variant=enhanced

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    iputils-ping \
    curl \
    iproute2 \
    net-tools \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy Python packages from builder
COPY --from=builder /build /usr/local/lib/python3.11/site-packages/

# Create logs and config directories
RUN mkdir -p /app/logs /app/config

# Copy application files (use improved versions as primary)
COPY monitor_internet_improved.py monitor_internet.py
COPY modem_reboot_improved.py modem_reboot.py
COPY network_diagnostics.py ./
COPY test_*.py ./
COPY *.md ./

# Set permissions
RUN chmod +x monitor_internet.py modem_reboot.py network_diagnostics.py

# Set default environment variables for enhanced version
ENV MODEM_HOST="192.168.100.1" \
    MODEM_USERNAME="admin" \
    MODEM_PASSWORD="motorola" \
    MODEM_NOVERIFY="true" \
    CHECK_INTERVAL="60" \
    FAILURE_THRESHOLD="5" \
    RECOVERY_WAIT="600" \
    LOG_LEVEL="INFO" \
    LOG_FILE="/app/logs/watchdog.log" \
    ENABLE_DIAGNOSTICS="true" \
    DIAGNOSTICS_TIMEOUT="120" \
    OUTAGE_REPORT_INTERVAL="3600"

# Create non-root user for security
RUN useradd -r -u 1000 -m -c "watchdog user" -d /app -s /bin/bash watchdog && \
    chown -R watchdog:watchdog /app
USER watchdog

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD python3 -c "import os, sys; sys.exit(0 if os.path.exists('/app/logs/watchdog.log') else 1)" || \
        python3 -c "import sys; sys.exit(0)"

# Default command
ENTRYPOINT ["python3", "monitor_internet.py"]
